<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">üí∞ Budget Tracker</div>
            <ul class="nav-links">
                <li><a href="#" id="navDashboard">Dashboard</a></li>
                <li><a href="#" id="navBudget">Budget</a></li>
                <li><a href="#" id="navTransactions">Transactions</a></li>
                <li><a href="#" id="navReports">Reports</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="page-section active">
            <div class="summary-cards">
            <div class="card income">
                <h3>Total Income</h3>
                <div class="amount" id="totalIncome">$0</div>
                <div class="subtitle" id="incomeChange">Loading...</div>
            </div>
            <div class="card expenses">
                <h3>Total Expenses</h3>
                <div class="amount" id="totalExpenses">$0</div>
                <div class="subtitle" id="expensesChange">Loading...</div>
            </div>
            <div class="card balance">
                <h3>Current Balance</h3>
                <div class="amount" id="currentBalance">$0</div>
                <div class="subtitle">Available to spend</div>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>Recent Transactions</h2>
                <ul class="transaction-list" id="transactionList">
                    <!-- Transactions will be loaded here -->
                </ul>
                <button class="add-transaction-btn" onclick="openTransactionModal()">+ Add Transaction</button>
            </div>

            <div class="section">
                <h2>Spending by Category</h2>
                <div id="categoryDisplay">
                    <!-- Categories will be dynamically generated here -->
                </div>
                <button class="edit-categories-btn" onclick="openCategoriesModal()">Edit Categories</button>
            </div>
        </div>
    </div>

    <!-- Budget Section -->
    <div id="budgetSection" class="page-section">
        <div class="budget-header">
            <h1>Monthly Budget</h1>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚Üê</button>
                <span id="currentMonthYear"></span>
                <button onclick="changeMonth(1)">‚Üí</button>
            </div>
        </div>

        <!-- Income Section -->
        <div class="section">
            <div class="budget-section-header">
                <h2>üí∞ Expected Income</h2>
                <button class="btn-small btn-add-income" onclick="openAddIncomeCategoryModal()">+ Add Income Source</button>
            </div>
            <table class="budget-table">
                <thead>
                    <tr>
                        <th>Income Source</th>
                        <th>Expected</th>
                        <th>Actual</th>
                        <th>Difference</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="incomeTableBody">
                    <!-- Income rows will be loaded here -->
                </tbody>
            </table>
            <div class="income-summary">
                <strong>Total Expected Income:</strong> <span id="totalExpectedIncome">$0.00</span> | 
                <strong>Total Actual Income:</strong> <span id="totalActualIncome">$0.00</span>
            </div>
        </div>

        <!-- Expense Budget Section -->
        <div class="budget-summary-cards">
            <div class="card income">
                <h3>Total Expected Income</h3>
                <div class="amount" id="totalExpectedIncomeCard">$0</div>
            </div>
            <div class="card expenses">
                <h3>Total Budgeted</h3>
                <div class="amount" id="totalBudgeted">$0</div>
            </div>
            <div class="card balance">
                <h3>Remaining</h3>
                <div class="amount" id="totalRemaining">$0</div>
            </div>
        </div>

        <div class="section budget-table-section">
            <h2>üí≥ Expense Budget by Category</h2>
            <table class="budget-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Budgeted</th>
                        <th>Spent</th>
                        <th>Remaining</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- Budget rows will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Modal for Add Transaction -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Transaction</h2>
                <button class="close-btn" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm" onsubmit="handleTransactionSubmit(event)">
                <div class="transaction-type-toggle">
                    <button type="button" class="type-btn expense active" onclick="setTransactionType('expense', this)">Expense</button>
                    <button type="button" class="type-btn income" onclick="setTransactionType('income', this)">Income</button>
                </div>

                <div class="form-group">
                    <label for="transactionName">Description</label>
                    <input type="text" id="transactionName" name="name" placeholder="e.g., Grocery shopping" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionAmount">Amount</label>
                        <input type="number" id="transactionAmount" name="amount" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="transactionDate">Date</label>
                        <input type="date" id="transactionDate" name="date" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="transactionCategory">Category</label>
                    <select id="transactionCategory" name="category" required>
                        <option value="">Select a category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="transactionNotes">Notes (optional)</label>
                    <textarea id="transactionNotes" name="notes" rows="3" placeholder="Add any additional details..."></textarea>
                </div>

                <button type="submit" class="submit-btn">Add Transaction</button>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Categories -->
    <div class="modal" id="categoriesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Manage Categories</h2>
                <button class="close-btn" onclick="closeCategoriesModal()">&times;</button>
            </div>

            <div class="category-manager" id="categoryManager">
                <!-- Categories will be dynamically generated here -->
            </div>

            <div class="add-category-section">
                <input type="text" id="newCategoryInput" placeholder="New category name..." onkeypress="if(event.key==='Enter') addNewCategory()">
                <button onclick="addNewCategory()">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Income Categories -->
    <div class="modal" id="incomeCategoriesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Manage Income Sources</h2>
                <button class="close-btn" onclick="closeIncomeCategoriesModal()">&times;</button>
            </div>

            <div class="category-manager" id="incomeCategoryManager">
                <!-- Income categories will be dynamically generated here -->
            </div>

            <div class="add-category-section">
                <input type="text" id="newIncomeCategoryInput" placeholder="New income source..." onkeypress="if(event.key==='Enter') addNewIncomeCategory()">
                <button onclick="addNewIncomeCategory()">Add Income Source</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let categories = [];
        let incomeCategories = [];
        let currentTransactionType = 'expense';
        let currentBudgetMonth = new Date().getMonth() + 1;
        let currentBudgetYear = new Date().getFullYear();
        let currentSection = 'dashboard';

        // Load data on page load
        async function loadData() {
            await loadCategories();
            await loadIncomeCategories();
            await loadTransactions();
            await loadCategorySpending();
            updateSummaryCards();
        }

        // Load income categories from backend
        async function loadIncomeCategories() {
            try {
                const response = await fetch(`${API_URL}/categories?type=income`);
                incomeCategories = await response.json();
            } catch (error) {
                console.error('Error loading income categories:', error);
            }
        }

        // Load categories from backend
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`);
                categories = await response.json();
                populateCategoryDropdown();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load transactions from backend
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_URL}/transactions`);
                const transactions = await response.json();
                renderTransactions(transactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Load category spending from backend
        async function loadCategorySpending() {
            try {
                const response = await fetch(`${API_URL}/category-spending`);
                const spending = await response.json();
                renderCategoryDisplay(spending);
            } catch (error) {
                console.error('Error loading category spending:', error);
            }
        }

        // Render transactions list
        function renderTransactions(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            
            if (transactions.length === 0) {
                list.innerHTML = '<li style="padding: 2rem; text-align: center; color: #7f8c8d;">No transactions yet. Add your first transaction!</li>';
                return;
            }

            transactions.slice(0, 10).forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'transaction-item';
                
                const categoryName = categories.find(c => c.id === transaction.category_id)?.name || 'Uncategorized';
                const sign = transaction.transaction_type === 'income' ? '+' : '-';
                const amountClass = transaction.transaction_type === 'income' ? 'positive' : 'negative';
                
                li.innerHTML = `
                    <div class="transaction-info">
                        <span class="transaction-name">${transaction.description}</span>
                        <span class="transaction-category">${categoryName}</span>
                    </div>
                    <span class="transaction-amount ${amountClass}">${sign}$${transaction.amount.toFixed(2)}</span>
                `;
                list.appendChild(li);
            });
        }

        // Update summary cards
        async function updateSummaryCards() {
            try {
                const response = await fetch(`${API_URL}/transactions`);
                const transactions = await response.json();
                
                const income = transactions
                    .filter(t => t.transaction_type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expenses = transactions
                    .filter(t => t.transaction_type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = income - expenses;
                
                document.getElementById('totalIncome').textContent = `$${income.toFixed(2)}`;
                document.getElementById('totalExpenses').textContent = `$${expenses.toFixed(2)}`;
                document.getElementById('currentBalance').textContent = `$${balance.toFixed(2)}`;
            } catch (error) {
                console.error('Error updating summary:', error);
            }
        }

        // Populate category dropdown in transaction form
        function populateCategoryDropdown(transactionType = 'expense') {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Select a category</option>';

            // Use income categories for income transactions, expense categories for expense transactions
            const categoriesToUse = transactionType === 'income' ? incomeCategories : categories;

            if (categoriesToUse.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = `No ${transactionType} categories available`;
                option.disabled = true;
                select.appendChild(option);
                return;
            }

            categoriesToUse.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);

                // Add subcategories
                if (category.subcategories && category.subcategories.length > 0) {
                    category.subcategories.forEach(sub => {
                        const subOption = document.createElement('option');
                        subOption.value = sub.id;
                        subOption.textContent = `  ‚Ü≥ ${sub.name}`;
                        select.appendChild(subOption);
                    });
                }
            });
        }

        // Render category spending display
        function renderCategoryDisplay(spending) {
            const display = document.getElementById('categoryDisplay');
            display.innerHTML = '';
            
            if (spending.length === 0) {
                display.innerHTML = '<p style="padding: 1rem; text-align: center; color: #7f8c8d;">No categories yet</p>';
                return;
            }

            const maxAmount = Math.max(...spending.map(s => s.amount), 1);
            
            spending.forEach(item => {
                const percentage = (item.amount / maxAmount) * 100;
                
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                let badgeHTML = '';
                if (item.subcategory_count > 0) {
                    badgeHTML = `<span class="subcategory-badge">${item.subcategory_count}</span>`;
                }
                
                categoryItem.innerHTML = `
                    <div class="category-name-section">
                        <span class="category-name">${item.category_name}</span>
                        ${badgeHTML}
                    </div>
                    <div class="category-bar">
                        <div class="category-bar-fill" style="width: ${percentage}%;"></div>
                    </div>
                    <span class="category-amount">$${item.amount.toFixed(2)}</span>
                `;
                
                display.appendChild(categoryItem);
            });
        }

        // Transaction Modal Functions
        function openTransactionModal() {
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('transactionDate').valueAsDate = new Date();
            // Populate categories based on current transaction type (defaults to expense)
            populateCategoryDropdown(currentTransactionType);
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            // Reset transaction type to expense
            currentTransactionType = 'expense';
            const expenseBtn = document.querySelector('.type-btn.expense');
            if (expenseBtn) {
                document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                expenseBtn.classList.add('active');
            }
        }

        function setTransactionType(type, button) {
            currentTransactionType = type;
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            // Refresh the category dropdown to show appropriate categories
            populateCategoryDropdown(type);

            // Update description field requirement based on transaction type
            const descriptionField = document.getElementById('transactionName');
            if (type === 'income') {
                descriptionField.removeAttribute('required');
                descriptionField.placeholder = 'e.g., Monthly salary (optional)';
            } else {
                descriptionField.setAttribute('required', 'required');
                descriptionField.placeholder = 'e.g., Grocery shopping';
            }
        }

        async function handleTransactionSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            let description = formData.get('name') || '';

            // If income and no description provided, use category name
            if (currentTransactionType === 'income' && !description.trim()) {
                const categoryId = parseInt(formData.get('category'));
                const category = incomeCategories.find(c => c.id === categoryId);
                description = category ? category.name : 'Income';
            }

            const transaction = {
                description: description,
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date'),
                transaction_type: currentTransactionType,
                category_id: parseInt(formData.get('category')) || null,
                notes: formData.get('notes')
            };

            try {
                const response = await fetch(`${API_URL}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transaction)
                });

                if (response.ok) {
                    alert('Transaction added successfully!');
                    closeTransactionModal();
                    event.target.reset();
                    await loadTransactions();
                    await loadCategorySpending();
                    await updateSummaryCards();
                }
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('Error adding transaction. Please try again.');
            }
        }

        // Categories Modal Functions
        function openCategoriesModal() {
            renderCategories();
            document.getElementById('categoriesModal').classList.add('active');
        }

        function closeCategoriesModal() {
            document.getElementById('categoriesModal').classList.remove('active');
            loadCategories();
            loadCategorySpending();
        }

        function renderCategories() {
            const manager = document.getElementById('categoryManager');
            manager.innerHTML = '';
            
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-tree-item';
                
                const categoryRow = document.createElement('div');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `
                    <span class="category-icon">üìÅ</span>
                    <input type="text" value="${category.name}" onchange="updateCategoryName(${category.id}, this.value)">
                    <button class="btn-small btn-add-sub" onclick="addSubcategory(${category.id})">+ Sub</button>
                    <button class="btn-small btn-delete" onclick="deleteCategory(${category.id})">Delete</button>
                `;
                
                categoryDiv.appendChild(categoryRow);
                
                if (category.subcategories && category.subcategories.length > 0) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'subcategory-container';
                    
                    category.subcategories.forEach(sub => {
                        const subRow = document.createElement('div');
                        subRow.className = 'category-row subcategory';
                        subRow.innerHTML = `
                            <span class="category-icon">üìÑ</span>
                            <input type="text" value="${sub.name}" onchange="updateSubcategoryName(${sub.id}, this.value)">
                            <button class="btn-small btn-delete" onclick="deleteCategory(${sub.id})">Delete</button>
                        `;
                        subContainer.appendChild(subRow);
                    });
                    
                    categoryDiv.appendChild(subContainer);
                }
                
                manager.appendChild(categoryDiv);
            });
        }

        async function updateCategoryName(categoryId, newName) {
            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                });
            } catch (error) {
                console.error('Error updating category:', error);
            }
        }

        async function updateSubcategoryName(subId, newName) {
            await updateCategoryName(subId, newName);
        }

        async function addSubcategory(parentId) {
            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'New Subcategory',
                        parent_id: parentId
                    })
                });

                if (response.ok) {
                    await loadCategories();
                    renderCategories();
                }
            } catch (error) {
                console.error('Error adding subcategory:', error);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Delete this category? This will also delete all its subcategories and associated transactions.')) {
                return;
            }

            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                await loadCategories();
                renderCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
            }
        }

        async function addNewCategory() {
            const input = document.getElementById('newCategoryInput');
            const categoryName = input.value.trim();
            
            if (!categoryName) return;

            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        parent_id: null
                    })
                });

                if (response.ok) {
                    input.value = '';
                    await loadCategories();
                    renderCategories();
                }
            } catch (error) {
                console.error('Error adding category:', error);
            }
        }

        // Income Categories Modal Functions
        function openAddIncomeCategoryModal() {
            renderIncomeCategories();
            document.getElementById('incomeCategoriesModal').classList.add('active');
        }

        function closeIncomeCategoriesModal() {
            document.getElementById('incomeCategoriesModal').classList.remove('active');
            loadIncomeCategories();
            if (currentSection === 'budget') {
                loadBudgetData();
            }
        }

        function renderIncomeCategories() {
            const manager = document.getElementById('incomeCategoryManager');
            manager.innerHTML = '';

            if (incomeCategories.length === 0) {
                manager.innerHTML = '<p style="padding: 1rem; text-align: center; color: #7f8c8d;">No income sources yet. Add your first income source below!</p>';
                return;
            }

            incomeCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-tree-item';

                const categoryRow = document.createElement('div');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `
                    <span class="category-icon">üí∞</span>
                    <input type="text" value="${category.name}" onchange="updateIncomeCategoryName(${category.id}, this.value)">
                    <button class="btn-small btn-delete" onclick="deleteIncomeCategory(${category.id})">Delete</button>
                `;

                categoryDiv.appendChild(categoryRow);
                manager.appendChild(categoryDiv);
            });
        }

        async function updateIncomeCategoryName(categoryId, newName) {
            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                });
            } catch (error) {
                console.error('Error updating income category:', error);
            }
        }

        async function deleteIncomeCategory(categoryId) {
            if (!confirm('Delete this income source? This will also delete all associated transactions.')) {
                return;
            }

            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                await loadIncomeCategories();
                renderIncomeCategories();
            } catch (error) {
                console.error('Error deleting income category:', error);
            }
        }

        async function addNewIncomeCategory() {
            console.log('addNewIncomeCategory called');
            const input = document.getElementById('newIncomeCategoryInput');
            const categoryName = input.value.trim();
            console.log('Category name:', categoryName);

            if (!categoryName) {
                console.log('No category name provided');
                return;
            }

            try {
                console.log('Sending request to create income category');
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        parent_id: null,
                        category_type: 'income'
                    })
                });

                console.log('Response status:', response.status);
                if (response.ok) {
                    console.log('Income category added successfully');
                    input.value = '';
                    await loadIncomeCategories();
                    renderIncomeCategories();
                } else {
                    console.error('Failed to add income category:', response.statusText);
                }
            } catch (error) {
                console.error('Error adding income category:', error);
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const transactionModal = document.getElementById('transactionModal');
            const categoriesModal = document.getElementById('categoriesModal');
            const incomeCategoriesModal = document.getElementById('incomeCategoriesModal');

            if (event.target === transactionModal) {
                closeTransactionModal();
            }
            if (event.target === categoriesModal) {
                closeCategoriesModal();
            }
            if (event.target === incomeCategoriesModal) {
                closeIncomeCategoriesModal();
            }
        };

        // Initialize app
        window.onload = function() {
            loadData();
            updateMonthYearDisplay();
            setupNavigation();
        };

        // Setup Navigation Event Listeners
        function setupNavigation() {
            document.getElementById('navDashboard').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard');
            });
            
            document.getElementById('navBudget').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('budget');
            });
            
            document.getElementById('navTransactions').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard'); // For now, stays on dashboard
            });
            
            document.getElementById('navReports').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard'); // For now, stays on dashboard
            });
        }

        // Section Navigation
        function showSection(section) {
            console.log('Switching to section:', section);
            currentSection = section;
            document.querySelectorAll('.page-section').forEach(s => {
                s.classList.remove('active');
                console.log('Removed active from:', s.id);
            });
            
            if (section === 'dashboard') {
                document.getElementById('dashboardSection').classList.add('active');
                console.log('Activated dashboard');
            } else if (section === 'budget') {
                document.getElementById('budgetSection').classList.add('active');
                console.log('Activated budget');
                loadBudgetData();
            }
        }

        // Budget Functions
        function updateMonthYearDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonthYear').textContent = 
                `${monthNames[currentBudgetMonth - 1]} ${currentBudgetYear}`;
        }

        function changeMonth(direction) {
            currentBudgetMonth += direction;
            if (currentBudgetMonth > 12) {
                currentBudgetMonth = 1;
                currentBudgetYear++;
            } else if (currentBudgetMonth < 1) {
                currentBudgetMonth = 12;
                currentBudgetYear--;
            }
            updateMonthYearDisplay();
            loadBudgetData();
        }

        async function loadBudgetData() {
            try {
                // Load expense budget data
                const response = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=expense`);
                const budgetData = await response.json();
                renderBudgetTable(budgetData);
                updateBudgetSummary(budgetData);

                // Load income budget data
                const incomeResponse = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=income`);
                const incomeData = await incomeResponse.json();
                renderIncomeTable(incomeData);
                updateIncomeSummary(incomeData);
            } catch (error) {
                console.error('Error loading budget data:', error);
            }
        }

        function renderIncomeTable(incomeData) {
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = '';

            if (incomeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">No income sources found. Click "Add Income Source" to get started!</td></tr>';
                return;
            }

            incomeData.forEach(item => {
                const tr = document.createElement('tr');
                const difference = item.actual - item.budgeted;
                const differenceClass = difference >= 0 ? 'positive' : 'negative';
                const status = difference >= 0 ? '‚úì Met' : '‚ö† Under';
                const statusClass = difference >= 0 ? 'good' : 'under';

                tr.innerHTML = `
                    <td>
                        <strong>${item.category_name}</strong>
                    </td>
                    <td>
                        <input type="number"
                               class="budget-input"
                               value="${item.budgeted}"
                               min="0"
                               step="0.01"
                               onchange="updateBudget(${item.category_id}, this.value)"
                               placeholder="0.00">
                    </td>
                    <td class="income-amount">${item.actual.toFixed(2)}</td>
                    <td class="difference-amount ${differenceClass}">
                        ${difference >= 0 ? '+' : ''}${difference.toFixed(2)}
                    </td>
                    <td>
                        <span class="progress-text ${statusClass}">${status}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateIncomeSummary(incomeData) {
            const totalExpected = incomeData.reduce((sum, item) => sum + item.budgeted, 0);
            const totalActual = incomeData.reduce((sum, item) => sum + item.actual, 0);

            document.getElementById('totalExpectedIncome').textContent = `$${totalExpected.toFixed(2)}`;
            document.getElementById('totalActualIncome').textContent = `$${totalActual.toFixed(2)}`;
        }

        function renderBudgetTable(budgetData) {
            const tbody = document.getElementById('budgetTableBody');
            tbody.innerHTML = '';

            if (budgetData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">No categories found. Add categories first!</td></tr>';
                return;
            }

            budgetData.forEach(item => {
                // Render parent category row
                const tr = document.createElement('tr');
                tr.className = 'parent-category-row';
                const remaining = item.budgeted - item.actual;
                const percentage = item.budgeted > 0 ? (item.actual / item.budgeted) * 100 : 0;
                const progressClass = percentage > 100 ? 'over-budget' : percentage > 80 ? 'warning' : 'good';

                tr.innerHTML = `
                    <td>
                        <strong>${item.category_name}</strong>
                        ${item.subcategory_count > 0 ? `<span class="subcategory-badge">${item.subcategory_count}</span>` : ''}
                    </td>
                    <td class="parent-budget-cell">
                        <strong>$${item.budgeted.toFixed(2)}</strong>
                    </td>
                    <td class="spent-amount"><strong>$${item.actual.toFixed(2)}</strong></td>
                    <td class="remaining-amount ${remaining < 0 ? 'negative' : 'positive'}">
                        <strong>$${remaining.toFixed(2)}</strong>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-bar-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <span class="progress-text">${percentage.toFixed(0)}%</span>
                    </td>
                `;
                tbody.appendChild(tr);

                // Render subcategory rows if they exist
                if (item.subcategories && item.subcategories.length > 0) {
                    item.subcategories.forEach(sub => {
                        const subTr = document.createElement('tr');
                        subTr.className = 'subcategory-row';
                        const subRemaining = sub.budgeted - sub.actual;
                        const subPercentage = sub.budgeted > 0 ? (sub.actual / sub.budgeted) * 100 : 0;
                        const subProgressClass = subPercentage > 100 ? 'over-budget' : subPercentage > 80 ? 'warning' : 'good';

                        subTr.innerHTML = `
                            <td class="subcategory-name">
                                <span class="subcategory-indent">‚Ü≥</span> ${sub.category_name}
                            </td>
                            <td>
                                <input type="number"
                                       class="budget-input budget-input-small"
                                       value="${sub.budgeted}"
                                       min="0"
                                       step="0.01"
                                       onchange="updateBudget(${sub.category_id}, this.value)"
                                       placeholder="0.00">
                            </td>
                            <td class="spent-amount">$${sub.actual.toFixed(2)}</td>
                            <td class="remaining-amount ${subRemaining < 0 ? 'negative' : 'positive'}">
                                $${subRemaining.toFixed(2)}
                            </td>
                            <td>
                                <div class="progress-bar progress-bar-small">
                                    <div class="progress-bar-fill ${subProgressClass}" style="width: ${Math.min(subPercentage, 100)}%"></div>
                                </div>
                                <span class="progress-text progress-text-small">${subPercentage.toFixed(0)}%</span>
                            </td>
                        `;
                        tbody.appendChild(subTr);
                    });
                }
            });
        }

        async function updateBudgetSummary(budgetData) {
            const totalBudgeted = budgetData.reduce((sum, item) => sum + item.budgeted, 0);

            // Fetch income data to get total expected income
            try {
                const incomeResponse = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=income`);
                const incomeData = await incomeResponse.json();
                const totalExpectedIncome = incomeData.reduce((sum, item) => sum + item.budgeted, 0);

                // Calculate remaining: Expected Income - Total Budget
                const totalRemaining = totalExpectedIncome - totalBudgeted;

                document.getElementById('totalExpectedIncomeCard').textContent = `$${totalExpectedIncome.toFixed(2)}`;
                document.getElementById('totalBudgeted').textContent = `$${totalBudgeted.toFixed(2)}`;
                document.getElementById('totalRemaining').textContent = `$${totalRemaining.toFixed(2)}`;

                // Update color of remaining amount
                const remainingEl = document.getElementById('totalRemaining');
                remainingEl.parentElement.className = totalRemaining < 0 ? 'card expenses' : 'card balance';
            } catch (error) {
                console.error('Error fetching income data for budget summary:', error);
            }
        }

        async function updateBudget(categoryId, amount) {
            try {
                await fetch(`${API_URL}/budgets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category_id: categoryId,
                        amount: parseFloat(amount) || 0,
                        month: currentBudgetMonth,
                        year: currentBudgetYear
                    })
                });
                await loadBudgetData();
            } catch (error) {
                console.error('Error updating budget:', error);
                alert('Error updating budget. Please try again.');
            }
        }
    </script>
</body>
</html>