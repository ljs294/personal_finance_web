<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">üí∞ Budget Tracker</div>
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="#" id="navDashboard">Dashboard</a></li>
                    <li><a href="#" id="navBudget">Budget</a></li>
                    <li><a href="#" id="navTransactions">Transactions</a></li>
                    <li><a href="#" id="navReports">Reports</a></li>
                </ul>
                <div class="theme-dropdown">
                    <button class="theme-toggle" id="themeToggle" onclick="toggleThemeDropdown()">
                        <svg class="theme-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <!-- Sun icon (Day mode) -->
                            <path class="sun-icon" d="M10 3a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm6.364 1.636a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-1.636 6.364a1 1 0 01-1.414 0l-.707-.707a1 1 0 111.414-1.414l.707.707a1 1 0 010 1.414zM10 15a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-6.364.364a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM5 10a1 1 0 01-1-1 1 1 0 00-1-1 1 1 0 110-2 1 1 0 011-1 1 1 0 011 1v1a1 1 0 01-1 1zm-.636-6.364a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 7a3 3 0 100 6 3 3 0 000-6z"/>
                            <!-- Moon icon (Night mode) -->
                            <path class="moon-icon" style="display: none;" d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                            <!-- System icon (Auto mode) -->
                            <path class="system-icon" style="display: none;" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zm10 0a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M2 4l4 4 4-4"/>
                        </svg>
                    </button>
                    <div class="theme-dropdown-menu" id="themeDropdownMenu">
                        <div class="theme-option" onclick="selectTheme('day')">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 3a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm6.364 1.636a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-1.636 6.364a1 1 0 01-1.414 0l-.707-.707a1 1 0 111.414-1.414l.707.707a1 1 0 010 1.414zM10 15a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-6.364.364a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM5 10a1 1 0 01-1-1 1 1 0 00-1-1 1 1 0 110-2 1 1 0 011-1 1 1 0 011 1v1a1 1 0 01-1 1zm-.636-6.364a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 7a3 3 0 100 6 3 3 0 000-6z"/>
                            </svg>
                            <span>Day</span>
                            <svg class="checkmark" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </div>
                        <div class="theme-option" onclick="selectTheme('night')">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                            </svg>
                            <span>Night</span>
                            <svg class="checkmark" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </div>
                        <div class="theme-option" onclick="selectTheme('system')">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zm10 0a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                            </svg>
                            <span>System</span>
                            <svg class="checkmark" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="page-section active">
            <div class="summary-cards">
            <div class="card income">
                <h3>Total Income</h3>
                <div class="amount" id="totalIncome">$0</div>
                <div class="subtitle" id="incomeChange">Loading...</div>
            </div>
            <div class="card expenses">
                <h3>Total Expenses</h3>
                <div class="amount" id="totalExpenses">$0</div>
                <div class="subtitle" id="expensesChange">Loading...</div>
            </div>
            <div class="card balance">
                <h3>Current Balance</h3>
                <div class="amount" id="currentBalance">$0</div>
                <div class="subtitle">Available to spend</div>
            </div>
        </div>

        <div class="section chart-section">
            <h2>Spending Comparison</h2>
            <p class="chart-subtitle">Daily spending: This month vs. Previous month</p>
            <canvas id="spendingChart"></canvas>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>Recent Transactions</h2>
                <ul class="transaction-list" id="transactionList">
                    <!-- Transactions will be loaded here -->
                </ul>
                <button class="add-transaction-btn" onclick="openTransactionModal()">+ Add Transaction</button>
            </div>

            <div class="section">
                <h2>Spending by Category</h2>
                <div id="categoryDisplay">
                    <!-- Categories will be dynamically generated here -->
                </div>
                <button class="edit-categories-btn" onclick="openCategoriesModal()">Edit Categories</button>
            </div>
        </div>
    </div>

    <!-- Budget Section -->
    <div id="budgetSection" class="page-section">
        <div class="budget-header">
            <h1>Monthly Budget</h1>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚Üê</button>
                <span id="currentMonthYear"></span>
                <button onclick="changeMonth(1)">‚Üí</button>
            </div>
        </div>

        <!-- Income Section -->
        <div class="section">
            <div class="budget-section-header">
                <h2>üí∞ Expected Income</h2>
                <button class="btn-small btn-add-income" onclick="openAddIncomeCategoryModal()">+ Add Income Source</button>
            </div>
            <table class="budget-table">
                <thead>
                    <tr>
                        <th>Income Source</th>
                        <th>Expected</th>
                        <th>Actual</th>
                        <th>Difference</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="incomeTableBody">
                    <!-- Income rows will be loaded here -->
                </tbody>
            </table>
            <div class="income-summary">
                <strong>Total Expected Income:</strong> <span id="totalExpectedIncome">$0.00</span> | 
                <strong>Total Actual Income:</strong> <span id="totalActualIncome">$0.00</span>
            </div>
        </div>

        <!-- Expense Budget Section -->
        <div class="budget-summary-cards">
            <div class="card income">
                <h3>Total Expected Income</h3>
                <div class="amount" id="totalExpectedIncomeCard">$0</div>
            </div>
            <div class="card expenses">
                <h3>Total Budgeted</h3>
                <div class="amount" id="totalBudgeted">$0</div>
            </div>
            <div class="card balance">
                <h3>Remaining</h3>
                <div class="amount" id="totalRemaining">$0</div>
            </div>
        </div>

        <div class="section budget-table-section">
            <h2>üí≥ Expense Budget by Category</h2>
            <table class="budget-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Budgeted</th>
                        <th>Spent</th>
                        <th>Remaining</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- Budget rows will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Modal for Add/Edit Transaction -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="transactionModalTitle">Add Transaction</h2>
                <button class="close-btn" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm" onsubmit="handleTransactionSubmit(event)">
                <div class="transaction-type-toggle" id="transactionTypeToggle">
                    <button type="button" class="type-btn expense active" onclick="setTransactionType('expense', this)">Expense</button>
                    <button type="button" class="type-btn income" onclick="setTransactionType('income', this)">Income</button>
                </div>

                <div class="form-group">
                    <label for="transactionName">Description</label>
                    <input type="text" id="transactionName" name="name" placeholder="e.g., Grocery shopping" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionAmount">Amount</label>
                        <input type="number" id="transactionAmount" name="amount" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="transactionDate">Date</label>
                        <input type="date" id="transactionDate" name="date" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="transactionCategory">Category</label>
                    <select id="transactionCategory" name="category" required>
                        <option value="">Select a category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="transactionNotes">Notes (optional)</label>
                    <textarea id="transactionNotes" name="notes" rows="3" placeholder="Add any additional details..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="modal-action-btn save-btn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        <span id="saveButtonText">Save</span>
                    </button>
                    <button type="button" class="modal-action-btn discard-btn" onclick="discardTransactionChanges()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                        Discard
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Categories -->
    <div class="modal" id="categoriesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Manage Categories</h2>
                <button class="close-btn" onclick="closeCategoriesModal()">&times;</button>
            </div>

            <div class="category-manager" id="categoryManager">
                <!-- Categories will be dynamically generated here -->
            </div>

            <div class="add-category-section">
                <input type="text" id="newCategoryInput" placeholder="New category name..." onkeypress="if(event.key==='Enter') addNewCategory()">
                <button onclick="addNewCategory()">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Modal for Category Details -->
    <div class="modal" id="categoryDetailsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="categoryDetailsTitle">Category Details</h2>
                <button class="close-btn" onclick="closeCategoryDetailsModal()">&times;</button>
            </div>
            <div id="categoryDetailsContent">
                <!-- Category details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Income Categories -->
    <div class="modal" id="incomeCategoriesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Manage Income Sources</h2>
                <button class="close-btn" onclick="closeIncomeCategoriesModal()">&times;</button>
            </div>

            <div class="category-manager" id="incomeCategoryManager">
                <!-- Income categories will be dynamically generated here -->
            </div>

            <div class="add-category-section">
                <input type="text" id="newIncomeCategoryInput" placeholder="New income source..." onkeypress="if(event.key==='Enter') addNewIncomeCategory()">
                <button onclick="addNewIncomeCategory()">Add Income Source</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let categories = [];
        let incomeCategories = [];
        let currentTransactionType = 'expense';
        let currentBudgetMonth = new Date().getMonth() + 1;
        let currentBudgetYear = new Date().getFullYear();
        let currentSection = 'dashboard';
        let allTransactions = [];
        let editingTransactionId = null;
        let originalTransactionData = null;

        // Theme management
        let currentTheme = 'day'; // 'day', 'night', 'system'

        function initTheme() {
            // Load saved theme preference or default to 'system'
            const savedTheme = localStorage.getItem('theme') || 'system';
            currentTheme = savedTheme;
            applyTheme();
        }

        function toggleThemeDropdown() {
            const dropdown = document.getElementById('themeDropdownMenu');
            dropdown.classList.toggle('active');
        }

        function selectTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', currentTheme);
            applyTheme();
            updateThemeCheckmarks();
            // Close dropdown
            document.getElementById('themeDropdownMenu').classList.remove('active');
        }

        function updateThemeCheckmarks() {
            // Remove all active states
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });

            // Add active state to current theme
            const options = document.querySelectorAll('.theme-option');
            if (currentTheme === 'day') {
                options[0].classList.add('active');
            } else if (currentTheme === 'night') {
                options[1].classList.add('active');
            } else {
                options[2].classList.add('active');
            }
        }

        function applyTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            const systemIcon = document.querySelector('.system-icon');
            const body = document.body;

            // Hide all icons first
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'none';
            systemIcon.style.display = 'none';

            let shouldBeDark = false;

            if (currentTheme === 'day') {
                sunIcon.style.display = 'block';
                shouldBeDark = false;
            } else if (currentTheme === 'night') {
                moonIcon.style.display = 'block';
                shouldBeDark = true;
            } else { // system
                systemIcon.style.display = 'block';
                // Check system preference
                shouldBeDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }

            // Apply or remove dark mode class
            if (shouldBeDark) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }

            // Update checkmarks
            updateThemeCheckmarks();

            // Re-render chart with new theme colors if it exists
            if (spendingChart) {
                loadSpendingComparison();
            }
        }

        // Listen for system theme changes when in system mode
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (currentTheme === 'system') {
                applyTheme();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('themeDropdownMenu');
            const toggleButton = document.getElementById('themeToggle');

            if (!dropdown.contains(event.target) && !toggleButton.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Chart.js instance
        let spendingChart = null;

        // Load data on page load
        async function loadData() {
            await loadCategories();
            await loadIncomeCategories();
            await loadTransactions();
            await loadCategorySpending();
            await loadSpendingComparison();
            updateSummaryCards();
        }

        // Load and render spending comparison chart
        async function loadSpendingComparison() {
            try {
                const response = await fetch(`${API_URL}/spending-comparison`);
                const data = await response.json();
                renderSpendingChart(data);
            } catch (error) {
                console.error('Error loading spending comparison:', error);
            }
        }

        function renderSpendingChart(data) {
            const ctx = document.getElementById('spendingChart');

            // Destroy existing chart if it exists
            if (spendingChart) {
                spendingChart.destroy();
            }

            // Get month names
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            const currentMonthName = monthNames[data.current_month.month - 1];
            const prevMonthName = monthNames[data.previous_month.month - 1];

            // Determine if dark mode is active
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#e0e0e0' : '#2c3e50';
            const gridColor = isDarkMode ? '#404040' : '#ecf0f1';

            // Create budget line datasets (flat lines at budget amount)
            const currentBudgetLine = new Array(data.days.length).fill(data.current_month.budget);
            const prevBudgetLine = new Array(data.days.length).fill(data.previous_month.budget);

            spendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.days,
                    datasets: [
                        {
                            label: `${currentMonthName} ${data.current_month.year}`,
                            data: data.current_month.data,
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `${currentMonthName} Budget`,
                            data: currentBudgetLine,
                            backgroundColor: 'transparent',
                            borderColor: 'rgba(52, 152, 219, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        },
                        {
                            label: `${prevMonthName} ${data.previous_month.year}`,
                            data: data.previous_month.data,
                            backgroundColor: 'rgba(149, 165, 166, 0.1)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgba(149, 165, 166, 1)',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `${prevMonthName} Budget`,
                            data: prevBudgetLine,
                            backgroundColor: 'transparent',
                            borderColor: 'rgba(149, 165, 166, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: isDarkMode ? '#2d2d2d' : 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.parsed.y.toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Month',
                                color: textColor,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Spending ($)',
                                color: textColor,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        // Load income categories from backend
        async function loadIncomeCategories() {
            try {
                const response = await fetch(`${API_URL}/categories?type=income`);
                incomeCategories = await response.json();
            } catch (error) {
                console.error('Error loading income categories:', error);
            }
        }

        // Load categories from backend
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`);
                categories = await response.json();
                populateCategoryDropdown();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load transactions from backend
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_URL}/transactions`);
                allTransactions = await response.json();
                renderTransactions(allTransactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Load category spending from backend
        async function loadCategorySpending() {
            try {
                const response = await fetch(`${API_URL}/category-spending`);
                const spending = await response.json();
                renderCategoryDisplay(spending);
            } catch (error) {
                console.error('Error loading category spending:', error);
            }
        }

        // Render transactions list
        function renderTransactions(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';

            if (transactions.length === 0) {
                list.innerHTML = '<li style="padding: 2rem; text-align: center; color: #7f8c8d;">No transactions yet. Add your first transaction!</li>';
                return;
            }

            transactions.slice(0, 10).forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'transaction-item';
                li.dataset.id = transaction.id;

                // Get category name with proper hierarchy
                let categoryName = 'Uncategorized';
                if (transaction.category_id) {
                    // Use appropriate category list based on transaction type
                    const categoryList = transaction.transaction_type === 'income' ? incomeCategories : categories;

                    // First check if it's a top-level category
                    let category = categoryList.find(c => c.id === transaction.category_id);

                    if (category) {
                        categoryName = category.name;
                    } else {
                        // Check if it's a subcategory
                        for (const parentCat of categoryList) {
                            if (parentCat.subcategories && parentCat.subcategories.length > 0) {
                                const subcat = parentCat.subcategories.find(sc => sc.id === transaction.category_id);
                                if (subcat) {
                                    categoryName = `${parentCat.name} > ${subcat.name}`;
                                    break;
                                }
                            }
                        }
                    }
                }

                const sign = transaction.transaction_type === 'income' ? '+' : '-';
                const amountClass = transaction.transaction_type === 'income' ? 'positive' : 'negative';

                // Format date for display
                const transactionDate = new Date(transaction.date);
                const formattedDate = transactionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                li.innerHTML = `
                    <div class="transaction-info">
                        <span class="transaction-name">${transaction.description}</span>
                        <span class="transaction-category">${categoryName} ‚Ä¢ ${formattedDate}</span>
                    </div>
                    <div class="transaction-right">
                        <div class="transaction-actions">
                            <button class="transaction-action-btn edit-btn" onclick="editTransaction(${transaction.id})" title="Edit">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5z"/>
                                </svg>
                            </button>
                            <button class="transaction-action-btn delete-btn" onclick="deleteTransaction(${transaction.id})" title="Delete">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="transaction-amount ${amountClass}">${sign}$${transaction.amount.toFixed(2)}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // Edit transaction - open modal with pre-filled data
        function editTransaction(id) {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;

            // Store that we're editing
            editingTransactionId = id;
            originalTransactionData = { ...transaction };

            // Update modal title
            document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
            document.getElementById('saveButtonText').textContent = 'Save Changes';

            // Set transaction type and disable toggle during edit
            currentTransactionType = transaction.transaction_type;
            const expenseBtn = document.querySelector('.type-btn.expense');
            const incomeBtn = document.querySelector('.type-btn.income');

            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            if (transaction.transaction_type === 'income') {
                incomeBtn.classList.add('active');
            } else {
                expenseBtn.classList.add('active');
            }

            // Disable type toggle when editing
            document.getElementById('transactionTypeToggle').style.pointerEvents = 'none';
            document.getElementById('transactionTypeToggle').style.opacity = '0.6';

            // Populate form fields
            document.getElementById('transactionName').value = transaction.description;
            document.getElementById('transactionAmount').value = transaction.amount;

            // Format date for input
            const transactionDate = new Date(transaction.date);
            document.getElementById('transactionDate').value = transactionDate.toISOString().split('T')[0];

            document.getElementById('transactionNotes').value = transaction.notes || '';

            // Populate categories and select the right one
            populateCategoryDropdown(transaction.transaction_type);
            document.getElementById('transactionCategory').value = transaction.category_id;

            // Open modal
            document.getElementById('transactionModal').classList.add('active');
        }

        // Delete transaction
        async function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/transactions/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadTransactions();
                    await loadCategorySpending();
                    await updateSummaryCards();
                } else {
                    alert('Failed to delete transaction');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Error deleting transaction. Please try again.');
            }
        }

        // Update summary cards
        async function updateSummaryCards() {
            try {
                const response = await fetch(`${API_URL}/transactions`);
                const transactions = await response.json();
                
                const income = transactions
                    .filter(t => t.transaction_type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expenses = transactions
                    .filter(t => t.transaction_type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = income - expenses;
                
                document.getElementById('totalIncome').textContent = `$${income.toFixed(2)}`;
                document.getElementById('totalExpenses').textContent = `$${expenses.toFixed(2)}`;
                document.getElementById('currentBalance').textContent = `$${balance.toFixed(2)}`;
            } catch (error) {
                console.error('Error updating summary:', error);
            }
        }

        // Populate category dropdown in transaction form
        function populateCategoryDropdown(transactionType = 'expense') {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Select a category</option>';

            // Use income categories for income transactions, expense categories for expense transactions
            const categoriesToUse = transactionType === 'income' ? incomeCategories : categories;

            if (categoriesToUse.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = `No ${transactionType} categories available`;
                option.disabled = true;
                select.appendChild(option);
                return;
            }

            categoriesToUse.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);

                // Add subcategories
                if (category.subcategories && category.subcategories.length > 0) {
                    category.subcategories.forEach(sub => {
                        const subOption = document.createElement('option');
                        subOption.value = sub.id;
                        subOption.textContent = `  ‚Ü≥ ${sub.name}`;
                        select.appendChild(subOption);
                    });
                }
            });
        }

        // Render category spending display
        function renderCategoryDisplay(spending) {
            const display = document.getElementById('categoryDisplay');
            display.innerHTML = '';

            if (spending.length === 0) {
                display.innerHTML = '<p style="padding: 1rem; text-align: center; color: #7f8c8d;">No categories yet</p>';
                return;
            }

            spending.forEach(item => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item clickable';
                categoryItem.onclick = () => openCategoryDetails(item.category_id);

                let badgeHTML = '';
                if (item.subcategory_count > 0) {
                    badgeHTML = `<span class="subcategory-badge">${item.subcategory_count}</span>`;
                }

                // Calculate percentage and determine bar width and text
                let budgetPercentage = item.percentage || 0;
                let barWidth = Math.min(budgetPercentage, 100);
                let percentageText = '';
                let budgetInfoHTML = '';

                if (item.budget > 0) {
                    if (budgetPercentage > 100) {
                        // Over budget - show as full bar and display over-budget percentage
                        barWidth = 100;
                        const overPercentage = budgetPercentage - 100;
                        percentageText = `${budgetPercentage.toFixed(0)}% (${overPercentage.toFixed(0)}% over)`;
                    } else {
                        percentageText = `${budgetPercentage.toFixed(0)}%`;
                    }
                    budgetInfoHTML = `<span class="category-budget-info">${percentageText} of $${item.budget.toFixed(2)}</span>`;
                } else {
                    budgetInfoHTML = `<span class="category-budget-info no-budget">No budget set</span>`;
                }

                // Determine gradient class based on percentage
                let gradientClass = 'low';
                if (budgetPercentage >= 100) {
                    gradientClass = 'over';
                } else if (budgetPercentage >= 80) {
                    gradientClass = 'high';
                } else if (budgetPercentage >= 50) {
                    gradientClass = 'medium';
                }

                categoryItem.innerHTML = `
                    <div class="category-name-section">
                        <span class="category-name">${item.category_name}</span>
                        ${badgeHTML}
                    </div>
                    <div class="category-budget-bar">
                        <div class="category-budget-bar-fill gradient-${gradientClass}" style="width: ${barWidth}%;"></div>
                    </div>
                    <div class="category-right-section">
                        <span class="category-amount">$${item.amount.toFixed(2)}</span>
                        ${budgetInfoHTML}
                    </div>
                `;

                display.appendChild(categoryItem);
            });
        }

        // Transaction Modal Functions
        function openTransactionModal() {
            // Reset to add mode
            editingTransactionId = null;
            originalTransactionData = null;

            document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
            document.getElementById('saveButtonText').textContent = 'Save';

            // Enable type toggle
            document.getElementById('transactionTypeToggle').style.pointerEvents = 'auto';
            document.getElementById('transactionTypeToggle').style.opacity = '1';

            // Reset to expense type
            currentTransactionType = 'expense';
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.type-btn.expense').classList.add('active');

            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('transactionDate').valueAsDate = new Date();

            // Populate categories based on current transaction type (defaults to expense)
            populateCategoryDropdown(currentTransactionType);
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();

            // Reset state
            editingTransactionId = null;
            originalTransactionData = null;
            currentTransactionType = 'expense';

            // Re-enable type toggle
            document.getElementById('transactionTypeToggle').style.pointerEvents = 'auto';
            document.getElementById('transactionTypeToggle').style.opacity = '1';

            // Reset to expense
            const expenseBtn = document.querySelector('.type-btn.expense');
            if (expenseBtn) {
                document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                expenseBtn.classList.add('active');
            }
        }

        // Discard changes in modal
        function discardTransactionChanges() {
            if (editingTransactionId !== null) {
                // Editing mode - just close
                closeTransactionModal();
            } else {
                // Add mode - close
                closeTransactionModal();
            }
        }

        function setTransactionType(type, button) {
            currentTransactionType = type;
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            // Refresh the category dropdown to show appropriate categories
            populateCategoryDropdown(type);

            // Update description field requirement based on transaction type
            const descriptionField = document.getElementById('transactionName');
            if (type === 'income') {
                descriptionField.removeAttribute('required');
                descriptionField.placeholder = 'e.g., Monthly salary (optional)';
            } else {
                descriptionField.setAttribute('required', 'required');
                descriptionField.placeholder = 'e.g., Grocery shopping';
            }
        }

        async function handleTransactionSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            let description = formData.get('name') || '';

            // If income and no description provided, use category name
            if (currentTransactionType === 'income' && !description.trim()) {
                const categoryId = parseInt(formData.get('category'));
                const category = incomeCategories.find(c => c.id === categoryId);
                description = category ? category.name : 'Income';
            }

            const transaction = {
                description: description,
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date'),
                transaction_type: currentTransactionType,
                category_id: parseInt(formData.get('category')) || null,
                notes: formData.get('notes')
            };

            try {
                let response;
                if (editingTransactionId !== null) {
                    // Edit mode - PUT request
                    response = await fetch(`${API_URL}/transactions/${editingTransactionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(transaction)
                    });
                } else {
                    // Add mode - POST request
                    response = await fetch(`${API_URL}/transactions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(transaction)
                    });
                }

                if (response.ok) {
                    const message = editingTransactionId !== null ? 'Transaction updated successfully!' : 'Transaction added successfully!';
                    alert(message);
                    closeTransactionModal();
                    event.target.reset();
                    await loadTransactions();
                    await loadCategorySpending();
                    await updateSummaryCards();
                } else {
                    alert('Failed to save transaction');
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Error saving transaction. Please try again.');
            }
        }

        // Categories Modal Functions
        function openCategoriesModal() {
            renderCategories();
            document.getElementById('categoriesModal').classList.add('active');
        }

        function closeCategoriesModal() {
            document.getElementById('categoriesModal').classList.remove('active');
            loadCategories();
            loadCategorySpending();
        }

        function renderCategories() {
            const manager = document.getElementById('categoryManager');
            manager.innerHTML = '';
            
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-tree-item';
                
                const categoryRow = document.createElement('div');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `
                    <span class="category-icon">üìÅ</span>
                    <input type="text" value="${category.name}" onchange="updateCategoryName(${category.id}, this.value)">
                    <button class="btn-small btn-add-sub" onclick="addSubcategory(${category.id})">+ Sub</button>
                    <button class="btn-small btn-delete" onclick="deleteCategory(${category.id})">Delete</button>
                `;
                
                categoryDiv.appendChild(categoryRow);
                
                if (category.subcategories && category.subcategories.length > 0) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'subcategory-container';
                    
                    category.subcategories.forEach(sub => {
                        const subRow = document.createElement('div');
                        subRow.className = 'category-row subcategory';
                        subRow.innerHTML = `
                            <span class="category-icon">üìÑ</span>
                            <input type="text" value="${sub.name}" onchange="updateSubcategoryName(${sub.id}, this.value)">
                            <button class="btn-small btn-delete" onclick="deleteCategory(${sub.id})">Delete</button>
                        `;
                        subContainer.appendChild(subRow);
                    });
                    
                    categoryDiv.appendChild(subContainer);
                }
                
                manager.appendChild(categoryDiv);
            });
        }

        async function updateCategoryName(categoryId, newName) {
            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                });
            } catch (error) {
                console.error('Error updating category:', error);
            }
        }

        async function updateSubcategoryName(subId, newName) {
            await updateCategoryName(subId, newName);
        }

        async function addSubcategory(parentId) {
            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'New Subcategory',
                        parent_id: parentId
                    })
                });

                if (response.ok) {
                    await loadCategories();
                    renderCategories();
                }
            } catch (error) {
                console.error('Error adding subcategory:', error);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Delete this category? This will also delete all its subcategories and associated transactions.')) {
                return;
            }

            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                await loadCategories();
                renderCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
            }
        }

        async function addNewCategory() {
            const input = document.getElementById('newCategoryInput');
            const categoryName = input.value.trim();
            
            if (!categoryName) return;

            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        parent_id: null
                    })
                });

                if (response.ok) {
                    input.value = '';
                    await loadCategories();
                    renderCategories();
                }
            } catch (error) {
                console.error('Error adding category:', error);
            }
        }

        // Income Categories Modal Functions
        function openAddIncomeCategoryModal() {
            renderIncomeCategories();
            document.getElementById('incomeCategoriesModal').classList.add('active');
        }

        function closeIncomeCategoriesModal() {
            document.getElementById('incomeCategoriesModal').classList.remove('active');
            loadIncomeCategories();
            if (currentSection === 'budget') {
                loadBudgetData();
            }
        }

        function renderIncomeCategories() {
            const manager = document.getElementById('incomeCategoryManager');
            manager.innerHTML = '';

            if (incomeCategories.length === 0) {
                manager.innerHTML = '<p style="padding: 1rem; text-align: center; color: #7f8c8d;">No income sources yet. Add your first income source below!</p>';
                return;
            }

            incomeCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-tree-item';

                const categoryRow = document.createElement('div');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `
                    <span class="category-icon">üí∞</span>
                    <input type="text" value="${category.name}" onchange="updateIncomeCategoryName(${category.id}, this.value)">
                    <button class="btn-small btn-delete" onclick="deleteIncomeCategory(${category.id})">Delete</button>
                `;

                categoryDiv.appendChild(categoryRow);
                manager.appendChild(categoryDiv);
            });
        }

        async function updateIncomeCategoryName(categoryId, newName) {
            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                });
            } catch (error) {
                console.error('Error updating income category:', error);
            }
        }

        async function deleteIncomeCategory(categoryId) {
            if (!confirm('Delete this income source? This will also delete all associated transactions.')) {
                return;
            }

            try {
                await fetch(`${API_URL}/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                await loadIncomeCategories();
                renderIncomeCategories();
            } catch (error) {
                console.error('Error deleting income category:', error);
            }
        }

        async function addNewIncomeCategory() {
            console.log('addNewIncomeCategory called');
            const input = document.getElementById('newIncomeCategoryInput');
            const categoryName = input.value.trim();
            console.log('Category name:', categoryName);

            if (!categoryName) {
                console.log('No category name provided');
                return;
            }

            try {
                console.log('Sending request to create income category');
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        parent_id: null,
                        category_type: 'income'
                    })
                });

                console.log('Response status:', response.status);
                if (response.ok) {
                    console.log('Income category added successfully');
                    input.value = '';
                    await loadIncomeCategories();
                    renderIncomeCategories();
                } else {
                    console.error('Failed to add income category:', response.statusText);
                }
            } catch (error) {
                console.error('Error adding income category:', error);
            }
        }

        // Category Details Modal Functions
        async function openCategoryDetails(categoryId) {
            try {
                const now = new Date();
                const month = now.getMonth() + 1;
                const year = now.getFullYear();

                const response = await fetch(`${API_URL}/category-details/${categoryId}?month=${month}&year=${year}`);
                const data = await response.json();

                // Update modal title
                document.getElementById('categoryDetailsTitle').textContent = data.category_name;

                // Render category details
                renderCategoryDetails(data);

                // Open modal
                document.getElementById('categoryDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error loading category details:', error);
                alert('Error loading category details. Please try again.');
            }
        }

        function renderCategoryDetails(data) {
            const content = document.getElementById('categoryDetailsContent');

            // Calculate percentage for parent category
            let parentPercentage = 0;
            let parentBarWidth = 0;
            let parentGradientClass = 'low';

            if (data.budget > 0) {
                parentPercentage = (data.spent / data.budget) * 100;
                parentBarWidth = Math.min(parentPercentage, 100);

                if (parentPercentage >= 100) {
                    parentGradientClass = 'over';
                } else if (parentPercentage >= 80) {
                    parentGradientClass = 'high';
                } else if (parentPercentage >= 50) {
                    parentGradientClass = 'medium';
                }
            }

            let html = `
                <div class="category-details-summary">
                    <div class="details-row">
                        <span class="details-label">Total Spent:</span>
                        <span class="details-value spent">$${data.spent.toFixed(2)}</span>
                    </div>
                    <div class="details-row">
                        <span class="details-label">Budget:</span>
                        <span class="details-value">${data.budget > 0 ? '$' + data.budget.toFixed(2) : 'Not set'}</span>
                    </div>
                    ${data.budget > 0 ? `
                    <div class="details-row">
                        <span class="details-label">Remaining:</span>
                        <span class="details-value ${data.budget - data.spent >= 0 ? 'positive' : 'negative'}">$${(data.budget - data.spent).toFixed(2)}</span>
                    </div>
                    <div class="category-detail-bar-container">
                        <div class="category-budget-bar large">
                            <div class="category-budget-bar-fill gradient-${parentGradientClass}" style="width: ${parentBarWidth}%;"></div>
                        </div>
                        <span class="category-detail-percentage">${parentPercentage.toFixed(0)}%</span>
                    </div>
                    ` : ''}
                </div>
            `;

            // Add subcategories if they exist
            if (data.subcategories && data.subcategories.length > 0) {
                html += `
                    <div class="category-details-subcategories">
                        <h3>Subcategories</h3>
                        <div class="subcategory-list">
                `;

                data.subcategories.forEach(sub => {
                    let subPercentage = 0;
                    let subBarWidth = 0;
                    let subGradientClass = 'low';

                    if (sub.budget > 0) {
                        subPercentage = (sub.spent / sub.budget) * 100;
                        subBarWidth = Math.min(subPercentage, 100);

                        if (subPercentage >= 100) {
                            subGradientClass = 'over';
                        } else if (subPercentage >= 80) {
                            subGradientClass = 'high';
                        } else if (subPercentage >= 50) {
                            subGradientClass = 'medium';
                        }
                    }

                    html += `
                        <div class="subcategory-detail-item">
                            <div class="subcategory-detail-header">
                                <span class="subcategory-detail-name">${sub.name}</span>
                                <span class="subcategory-detail-amount">$${sub.spent.toFixed(2)}</span>
                            </div>
                            ${sub.budget > 0 ? `
                            <div class="subcategory-detail-budget">
                                <span class="budget-text">Budget: $${sub.budget.toFixed(2)}</span>
                                <span class="budget-remaining ${sub.budget - sub.spent >= 0 ? 'positive' : 'negative'}">
                                    $${(sub.budget - sub.spent).toFixed(2)} remaining
                                </span>
                            </div>
                            <div class="category-detail-bar-container">
                                <div class="category-budget-bar">
                                    <div class="category-budget-bar-fill gradient-${subGradientClass}" style="width: ${subBarWidth}%;"></div>
                                </div>
                                <span class="category-detail-percentage">${subPercentage.toFixed(0)}%</span>
                            </div>
                            ` : `
                            <div class="subcategory-detail-budget">
                                <span class="budget-text no-budget">No budget set</span>
                            </div>
                            `}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function closeCategoryDetailsModal() {
            document.getElementById('categoryDetailsModal').classList.remove('active');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const transactionModal = document.getElementById('transactionModal');
            const categoriesModal = document.getElementById('categoriesModal');
            const incomeCategoriesModal = document.getElementById('incomeCategoriesModal');
            const categoryDetailsModal = document.getElementById('categoryDetailsModal');

            if (event.target === transactionModal) {
                closeTransactionModal();
            }
            if (event.target === categoriesModal) {
                closeCategoriesModal();
            }
            if (event.target === incomeCategoriesModal) {
                closeIncomeCategoriesModal();
            }
            if (event.target === categoryDetailsModal) {
                closeCategoryDetailsModal();
            }
        };

        // Initialize app
        window.onload = function() {
            initTheme();
            loadData();
            updateMonthYearDisplay();
            setupNavigation();
        };

        // Setup Navigation Event Listeners
        function setupNavigation() {
            document.getElementById('navDashboard').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard');
            });
            
            document.getElementById('navBudget').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('budget');
            });
            
            document.getElementById('navTransactions').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard'); // For now, stays on dashboard
            });
            
            document.getElementById('navReports').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard'); // For now, stays on dashboard
            });
        }

        // Section Navigation
        function showSection(section) {
            console.log('Switching to section:', section);
            currentSection = section;
            document.querySelectorAll('.page-section').forEach(s => {
                s.classList.remove('active');
                console.log('Removed active from:', s.id);
            });
            
            if (section === 'dashboard') {
                document.getElementById('dashboardSection').classList.add('active');
                console.log('Activated dashboard');
            } else if (section === 'budget') {
                document.getElementById('budgetSection').classList.add('active');
                console.log('Activated budget');
                loadBudgetData();
            }
        }

        // Budget Functions
        function updateMonthYearDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonthYear').textContent = 
                `${monthNames[currentBudgetMonth - 1]} ${currentBudgetYear}`;
        }

        function changeMonth(direction) {
            currentBudgetMonth += direction;
            if (currentBudgetMonth > 12) {
                currentBudgetMonth = 1;
                currentBudgetYear++;
            } else if (currentBudgetMonth < 1) {
                currentBudgetMonth = 12;
                currentBudgetYear--;
            }
            updateMonthYearDisplay();
            loadBudgetData();
        }

        async function loadBudgetData() {
            try {
                // Load expense budget data
                const response = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=expense`);
                const budgetData = await response.json();
                renderBudgetTable(budgetData);
                updateBudgetSummary(budgetData);

                // Load income budget data
                const incomeResponse = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=income`);
                const incomeData = await incomeResponse.json();
                renderIncomeTable(incomeData);
                updateIncomeSummary(incomeData);
            } catch (error) {
                console.error('Error loading budget data:', error);
            }
        }

        function renderIncomeTable(incomeData) {
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = '';

            if (incomeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">No income sources found. Click "Add Income Source" to get started!</td></tr>';
                return;
            }

            incomeData.forEach(item => {
                const tr = document.createElement('tr');
                const difference = item.actual - item.budgeted;
                const differenceClass = difference >= 0 ? 'positive' : 'negative';
                const status = difference >= 0 ? '‚úì Met' : '‚ö† Under';
                const statusClass = difference >= 0 ? 'good' : 'under';

                tr.innerHTML = `
                    <td>
                        <strong>${item.category_name}</strong>
                    </td>
                    <td>
                        <input type="number"
                               class="budget-input"
                               value="${item.budgeted}"
                               min="0"
                               step="0.01"
                               onchange="updateBudget(${item.category_id}, this.value)"
                               placeholder="0.00">
                    </td>
                    <td class="income-amount">${item.actual.toFixed(2)}</td>
                    <td class="difference-amount ${differenceClass}">
                        ${difference >= 0 ? '+' : ''}${difference.toFixed(2)}
                    </td>
                    <td>
                        <span class="progress-text ${statusClass}">${status}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateIncomeSummary(incomeData) {
            const totalExpected = incomeData.reduce((sum, item) => sum + item.budgeted, 0);
            const totalActual = incomeData.reduce((sum, item) => sum + item.actual, 0);

            document.getElementById('totalExpectedIncome').textContent = `$${totalExpected.toFixed(2)}`;
            document.getElementById('totalActualIncome').textContent = `$${totalActual.toFixed(2)}`;
        }

        function renderBudgetTable(budgetData) {
            const tbody = document.getElementById('budgetTableBody');
            tbody.innerHTML = '';

            if (budgetData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">No categories found. Add categories first!</td></tr>';
                return;
            }

            budgetData.forEach(item => {
                // Render parent category row
                const tr = document.createElement('tr');
                tr.className = 'parent-category-row';
                const remaining = item.budgeted - item.actual;
                const percentage = item.budgeted > 0 ? (item.actual / item.budgeted) * 100 : 0;
                const progressClass = percentage > 100 ? 'over-budget' : percentage > 80 ? 'warning' : 'good';

                tr.innerHTML = `
                    <td>
                        <strong>${item.category_name}</strong>
                        ${item.subcategory_count > 0 ? `<span class="subcategory-badge">${item.subcategory_count}</span>` : ''}
                    </td>
                    <td class="parent-budget-cell">
                        <strong>$${item.budgeted.toFixed(2)}</strong>
                    </td>
                    <td class="spent-amount"><strong>$${item.actual.toFixed(2)}</strong></td>
                    <td class="remaining-amount ${remaining < 0 ? 'negative' : 'positive'}">
                        <strong>$${remaining.toFixed(2)}</strong>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-bar-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <span class="progress-text">${percentage.toFixed(0)}%</span>
                    </td>
                `;
                tbody.appendChild(tr);

                // Render subcategory rows if they exist
                if (item.subcategories && item.subcategories.length > 0) {
                    item.subcategories.forEach(sub => {
                        const subTr = document.createElement('tr');
                        subTr.className = 'subcategory-row';
                        const subRemaining = sub.budgeted - sub.actual;
                        const subPercentage = sub.budgeted > 0 ? (sub.actual / sub.budgeted) * 100 : 0;
                        const subProgressClass = subPercentage > 100 ? 'over-budget' : subPercentage > 80 ? 'warning' : 'good';

                        subTr.innerHTML = `
                            <td class="subcategory-name">
                                <span class="subcategory-indent">‚Ü≥</span> ${sub.category_name}
                            </td>
                            <td>
                                <input type="number"
                                       class="budget-input budget-input-small"
                                       value="${sub.budgeted}"
                                       min="0"
                                       step="0.01"
                                       onchange="updateBudget(${sub.category_id}, this.value)"
                                       placeholder="0.00">
                            </td>
                            <td class="spent-amount">$${sub.actual.toFixed(2)}</td>
                            <td class="remaining-amount ${subRemaining < 0 ? 'negative' : 'positive'}">
                                $${subRemaining.toFixed(2)}
                            </td>
                            <td>
                                <div class="progress-bar progress-bar-small">
                                    <div class="progress-bar-fill ${subProgressClass}" style="width: ${Math.min(subPercentage, 100)}%"></div>
                                </div>
                                <span class="progress-text progress-text-small">${subPercentage.toFixed(0)}%</span>
                            </td>
                        `;
                        tbody.appendChild(subTr);
                    });
                }
            });
        }

        async function updateBudgetSummary(budgetData) {
            const totalBudgeted = budgetData.reduce((sum, item) => sum + item.budgeted, 0);

            // Fetch income data to get total expected income
            try {
                const incomeResponse = await fetch(`${API_URL}/budget-overview?month=${currentBudgetMonth}&year=${currentBudgetYear}&type=income`);
                const incomeData = await incomeResponse.json();
                const totalExpectedIncome = incomeData.reduce((sum, item) => sum + item.budgeted, 0);

                // Calculate remaining: Expected Income - Total Budget
                const totalRemaining = totalExpectedIncome - totalBudgeted;

                document.getElementById('totalExpectedIncomeCard').textContent = `$${totalExpectedIncome.toFixed(2)}`;
                document.getElementById('totalBudgeted').textContent = `$${totalBudgeted.toFixed(2)}`;
                document.getElementById('totalRemaining').textContent = `$${totalRemaining.toFixed(2)}`;

                // Update color of remaining amount
                const remainingEl = document.getElementById('totalRemaining');
                remainingEl.parentElement.className = totalRemaining < 0 ? 'card expenses' : 'card balance';
            } catch (error) {
                console.error('Error fetching income data for budget summary:', error);
            }
        }

        async function updateBudget(categoryId, amount) {
            try {
                await fetch(`${API_URL}/budgets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category_id: categoryId,
                        amount: parseFloat(amount) || 0,
                        month: currentBudgetMonth,
                        year: currentBudgetYear
                    })
                });
                await loadBudgetData();
            } catch (error) {
                console.error('Error updating budget:', error);
                alert('Error updating budget. Please try again.');
            }
        }
    </script>
</body>
</html>